<!DOCTYPE html>
<html lang="en">
<head>
    <title>WasteWorld</title>
    <meta charset="UTF-8">
    <link rel='stylesheet' href='style.css'>
    <meta name="monetization" content="$ilp.gatehub.net/407176549">
</head>
<body>

<div id='camera'>
    <div id='scene'>

    </div>
</div>
<div id='pause' hidden>
    Game Paused<br><br>
    <button onclick='togglePause(false)'>RESUME</button><br><br>
    Render Distance<br>
    <!--<button onclick='updateRenderDistance(0)'>0</button>-->
    <button onclick='updateRenderDistance(1)'>1</button>
    <button onclick='updateRenderDistance(2)'>2</button>
    <button onclick='updateRenderDistance(3)'>3</button>
    <button onclick='updateRenderDistance(4)'>4</button><br><br><button onclick='location.reload()'>QUIT</button>
</div>
<div id='inv' hidden>
    <button class='invBut invCraftBut' onclick='togglePause(false)'>X</button><br>
    <button class='invBut invCraftBut' onclick='changeInventory(true)'>C<br>R<br>A<br>F<br>T</button><br>
    <button class='invBut invItemsBut' onclick='changeInventory(false)'>I<br>T<br>E<br>M<br>S</button>
    <div class='itemList' id='invList'>

    </div>
    <button class='reqs' id='reqs' onclick='craftRecipe(selectedRecipe)'></button>
    <div class='desc' id='cDesc'><!--Only 8 of these batteries can power a World Filtration Systemâ„¢--></div>
</div>
<div id='crosshair' hidden></div>
<div id='give' hidden>[G] Give Resource</div>
<div id='currentBlock' hidden>
    <div class='previewFace' style='transform: rotateY(0) translateZ(50px)'></div>
    <div class='previewFace' style='transform: rotateY(90deg) translateZ(50px)'></div>
    <div class='previewFace' style='transform: rotateX(90deg) translateZ(50px)'></div>
</div>
<div id='itemCount'></div>
<div id='rad'></div>
<div class='statusbar' id='hp' hidden></div>
<div class='statusbar' id='mask' hidden></div>

</body>
<div id='chatlog'>
    <div style='position: relative; height: 100%'></div>
</div>
<input id='chatField' maxlength='50' hidden>
<div id='menu'>
    <!--<img style='margin-top: 50px' src='logo.png'><br>-->
    <iframe width='400' src='logo.html' style='border: none; margin-left: -50px; margin-top: 30px' ></iframe>
    <div style='font-family: emoji; opacity: 0.001'>ðŸª¨</div>
    <div id='preview'>
        <input class='cColor' id='color1' type='color'>
        <input class='cColor' id='color2' type='color' hidden>
        <input class='cColor' id='hair' type='color' value='#d1d425'>
        <input class='cColor' id='skin' value='#deac9d' type='color'>
        <input id='name' maxlength='20' value='Player'>
        <input id='color' hidden>
        <div id='skinTypes' hidden>
            <button onclick='changeSkinMode(0)'></button>
            <button onclick='changeSkinMode(1)'></button>
            <button onclick='changeSkinMode(2)'></button>
            <button onclick='changeSkinMode(3)'></button>
            <button onclick='changeSkinMode(4)'></button>
        </div>
    </div>

    <div id='buttons'>
        <button onclick='openMenu(true)'>HOST GAME</button><br>
        <button onclick='openMenu(false)'>JOIN GAME</button>
    </div>
    <br>

    <div id='worlds' hidden>
        <button onclick='backToMenu()'>Back to Menu</button><br><br>
        <div id='worldList'>
        </div><br>
        <div id='butJoin' hidden>
            <input id='sessionID' placeholder='Session ID' maxlength='4'> <button onclick='joinGame(s("sessionID").value.toUpperCase())'>Join Game</button>
        </div>
        <div id='butHost'>
            <label><input type='checkbox' id='public'> Public Game</label><br>
            <input value='World N' maxlength='20' id='worldName'> <button onclick='hostGame(-1)'>Create World</button>
        </div>
        <div>

        </div>
    </div>

</div>
<canvas hidden id='texture'></canvas>

<script src='zzfxm.min.js'></script>
<script src="/socket.io/socket.io.js"></script>
<script src='helpers.js'></script>
<script src='texture.js'></script>
<script src='blocks.js'></script>
<script src='inventory.js'></script>

<script src='classes.js'></script>
<script src='simplex-noise.js'></script>
<script src='models.js'></script>
<script src='main.js'></script>
<script>

    s('color1').value = s('color2').value = '#' + Math.floor(r()*16777215).toString(16);

    function setupPreview()
    {
        const previewChar = createPlayerModel('blue')
        const previewElem = s('preview')

        previewElem.appendChild(previewChar)

        const pos = {y: previewElem.offsetTop + 100, x: previewElem.offsetLeft + 100}

        previewChar.head.style.transition = ''

        window.previewEvent = e => {
            const relPos =
                {
                    x: (e.clientX - pos.x) / 30,
                    y: (e.clientY - pos.y) / 20,
                }
            previewChar.head.style.transform = `translateY(-135px) rotateX(${relPos.y}deg) rotateY(${relPos.x}deg)`

        }
        window.addEventListener('mousemove', previewEvent)

        window.previewInterval = setInterval(()=>{
            s('color1').onchange()
            s('color2').onchange()
            s('hair').onchange()
            s('skin').onchange()
            saveChar()
        },50)

        s('color1').onchange = () => {s('color').value = parseSkin(); previewChar.style.setProperty('--bg', s('color').value)}
        s('color2').onchange = () => {s('color').value = parseSkin(); previewChar.style.setProperty('--bg', s('color').value)}
        s('hair').onchange = () => previewChar.style.setProperty('--hair', s('hair').value)
        s('skin').onchange = () => previewChar.style.setProperty('--skin', s('skin').value)
    }

    let skinMode = 0

    function parseSkin(c1 = s('color1').value, c2 = s('color2').value, m = skinMode)
    {
        /*const c1 = s('color1').value
        const c2 = s('color2').value*/

        return [
            c1,
            `linear-gradient(90deg, ${c1} 50%,${c2} 50%)`,
            `linear-gradient(${c1} 50%,${c2} 50%,${c2} 60%, ${c1} 60%)`,
            `conic-gradient(${c1} 25%,${c2} 25%,${c2} 50%, ${c1} 50%,${c1} 75%,${c2} 75%,${c2} 100%, ${c1} 100%)`,
            `linear-gradient(${c1},${c2})`,
        ][m]
    }
    function changeSkinMode(id)
    {
        skinMode = id
        s('color1').onchange()
    }

    for(let i = 0; i < 5; ++i)
    {
        s('skinTypes').querySelectorAll('button')[i].style.background = parseSkin('#EED', '#112', i)
    }

    setupPreview()

    function openMenu(host)
    {
        s('preview').style.display = 'none'
        s('buttons').style.display = 'none'
        s('worlds').hidden = false
        s('butHost').hidden = !host
        s('butJoin').hidden = host
        s('worldList').innerHTML = ''

        if(host)
        {
            for(let i in saveData) if(saveData[i])
            {
                s('worldList').innerHTML += ` <button onclick='hostGame(${i})' class='elem'>${saveData[i][2]}</button> <button onclick='deleteWorld(${i})' class='delete'>ðŸ—‘</button>`
            }
            s('worldName').value = 'World ' + +(saveData.length + 1)
        }
        else
        {
            joinMenuOpen = true
            emit('server_list')
            joinMenuInterval = setInterval(() => emit('server_list'),5000)
        }

    }


    function backToMenu()
    {
        joinMenuOpen = false
        s('preview').style.display = 'inline-block'
        s('buttons').style.display = 'flex'
        s('worlds').hidden = true
        if(joinMenuInterval)
            clearInterval(joinMenuInterval)
    }
    let joinMenuOpen = false
    let joinMenuInterval;

    function listServers(data)
    {
        if(!joinMenuOpen)
            return

        s('worldList').innerHTML = ''

        data.forEach(server => {
            s('worldList').innerHTML += `<button class='elem server' onclick='joinGame("${cleanMessage(server[0])}")'>${cleanMessage(server[1])} <div class='code'>${cleanMessage(server[0])}</div> </button>`
        })
    }
    function deleteWorld(i)
    {
        if(confirm('Are you sure you want to delete ' + saveData[i][2]))
            delete saveData[i]

        openMenu(true)
        localStorage.setItem('js13kraft_saves', JSON.stringify(saveData))
    }

    initSave()
    if(window.io)
        window.socket = io({ upgrade: false, transports: ["websocket"] })
    on('server_list', data => listServers(data))
    on('server_exists', data => {
        if(data[0])
        {
            if(joinMenuInterval)
                clearInterval(joinMenuInterval)
            startCommon()
            joinServer(data[1])
        }
        else
        {
            alert('Could not find ' + data[1])
        }
    })

    function saveChar()
    {
        localStorage.setItem('js13kraft_char', JSON.stringify([s('name').value, s('color1').value, s('color2').value, s('hair').value, s('skin').value, skinMode]))
    }

    function loadChar()
    {
        const g = localStorage.getItem('js13kraft_char')
        if(g)
        {
            const parts = JSON.parse(g)
            s('name').value = parts[0]
            s('color1').value = parts[1]
            s('color2').value = parts[2]
            s('hair').value = parts[3]
            s('skin').value = parts[4]
            changeSkinMode(parts[5])
        }
    }

    loadChar()



</script>

</html>
